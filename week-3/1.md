---
theme: gaia
_class: lead
paginate: true
backgroundColor: #fff
backgroundImage: url('https://s3.iwanhae.kr/public/bg.png')
marp: true
style: |
  section::after {
    left: 0;
    right: 0;
    top: 0;
    text-align: left;
  }
---

![bg left:40% 80%](https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.svg)

# **Kubernetes Controller**

ëŸ¬ë‹ìŠ¤í‘¼ì¦ˆ
Kubernetes Deep Dive - 3ì£¼ì°¨ - 1êµì‹œ

---

# ëª©ì°¨

1. Controller Pattern
   1-1. ì„ ì–¸í˜• API ì™€ Controller íŒ¨í„´
   1-2. kube-controller-manager ì˜ ì˜ˆì‹œ
   1-2-1. Deployment
   1-2-2. StatefulSet
   1-2-3. DaemonSet

---

# ì„ ì–¸í˜• API ë€?

ê¸°ë³¸ì ì¸ ì»¨ì…‰ì€

1. ë‚´ê°€ ì›í•˜ëŠ” ìƒíƒœë¥¼ ì„ ì–¸í•œë‹¤.
2. ì‹œìŠ¤í…œì€ ë‚´ê°€ ì›í•˜ëŠ” ìƒíƒœë¡œ ë§ì¶°ì¤€ë‹¤.

- [Docker](https://docs.docker.com/engine/api/v1.43/) > ëª…ë ¹í˜•
- [K8s](https://s3.iwanhae.kr/public/k8s/index.html) > ì„ ì–¸í˜•

---

# ì–´ë–»ê²Œ "ì‹œìŠ¤í…œì€ ë‚´ê°€ ì›í•˜ëŠ” ìƒíƒœë¡œ ë§ì¶°"ì¤„ê¹Œ?

-> Controller Pattern

---

# ì—ì–´ì»¨ ì»¨íŠ¸ë¡¤ëŸ¬

- Closed Loop System
- ê¸°ê³„ê³µí•™ì—ì„œëŠ” í—ˆêµ¬í•œë‚  ì“°ëŠ” ìš©ì–´
- ê¸°ê³„ê³µí•™ì˜ ê°œë…ì„ CSì—ì„œ ë¹Œë ¤ì˜´

![bg right:50%](./1.AC.png)

---

# K8s Controller

[link](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/controllers.md)

```go
for {
  desired := getDesiredState()
  current := getCurrentState()
  makeChanges(desired, current)
}
```

---

# ë¬¼ë¡  í˜„ì‹¤ì€ ì €ë ‡ê²Œ ê°„ë‹¨í•˜ì§„ ì•ŠìŒ - 1

[link](https://cloudark.medium.com/kubernetes-custom-controllers-b6c7d0668fdf)

- ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì¤„ì´ê¸°ìœ„í•œ ìºì‹±
- ë™ì‹œì„± ì´ìŠˆë¥¼ ì²˜ë¦¬í•˜ê¸°ìœ„í•œ íì‰

![bg](./1.controller.webp)

---

# ë¬¼ë¡  í˜„ì‹¤ì€ ì €ë ‡ê²Œ ê°„ë‹¨í•˜ì§„ ì•ŠìŒ - 2

- `kubectl get leases.coordination.k8s.io`
- ë™ì‹œê°„ì— í•˜ë‚˜ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì¡°ì‘í•˜ëŠ”ê±´ ìµœëŒ€ 1ê°œì˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë˜ê²Œí•˜ê¸°ìœ„í•œ lease api

---

K8s ì˜ **ê±°ì˜ ëŒ€ë¶€ë¶„ì˜** ìš”ì†ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ íŒ¨í„´ì„ ë”°ë¦„

- `kubelet`: Pod ì˜ desiredState ë³´ê³  CRI ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì˜ Current State ê°€ Desired State ì™€ ê°™ê²Œ ë…¸ë ¥
- `kube-proxy`: Service ì˜ desiredState ë¥¼ ë³´ê³  IPTables ì™€ IPVS ë¥¼ ì¡°ì‘í•´ Current State ê°€ (ì´í•˜ìƒëµ)
- `cloud-controller-manager`: Node, Loadbalancer ë“±ì˜ desiredState ë³´ê³  CSP API ì°”ëŸ¬ì„œ Current.. (ì´í•˜ìƒëµ)
- `kube-controller-manager`: ìœ„ì™€ ê°™ì€ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ 40ê°œ ë„˜ê²Œ ëŒì•„ê°€ëŠ” ì»´í¬ë„ŒíŠ¸

ì˜ˆì™¸: `kube-shceduler`: Pod Spec ë³´ê³  Spec ì„ ì—…ë°ì´íŠ¸ í•¨ -> ì´ìƒí•˜ë‹ˆê¹ subresource ë¡œ ë³„ë„ë¡œ ë¹¼ëƒ„

---

# Q & A

---

# Q. kube-controller-manager ëŠ” ë­í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ ê°™ë‚˜ìš”?

---

# kube-controller-manager

- ëŒ€ì¶© 40ê°œê°€ ë„˜ì–´ê°€ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì„ í•˜ë‚˜ì˜ ë°”ì´ë„ˆë¦¬ë¡œ ë¬¶ì€ ì»´í¬ë„ŒíŠ¸
- ë¬¸ì ê·¸ëŒ€ë¡œì˜ ì˜ë¯¸ë¡œ ìš°ë¦¬ê°€ ì“°ëŠ” ëª¨ë“  K8s ì— ê¸°ëŒ€ë˜ëŠ” ì•¡ì…˜ì€ kube-controller-manager ê°€ í•´ì£¼ëŠ”ê²ƒ
- ê·¼ë° ë¬¸ì„œí™” ì•ˆë˜ì–´ìˆìŒ / ìì„¸íˆ ì•Œë ¤ë©´ ì½”ë“œë¥¼ ëœ¯ì–´ë³´ëŠ” ë°©ë²•ë°–ì—...
- ê·¸ëŸ¼ ì´ì œ ëœ¯ì–´ë´…ì‹œë‹¤ ğŸ˜

---

# kube-controller-manager ê°ì¡ê¸° - overview

https://github.com/kubernetes/kubernetes/tree/v1.27.4/cmd/kube-controller-manager/app

1. ë‹¤ì–‘í•œ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì¡´ì¬
2. ê° ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì–´ë–¤ ë¦¬ì†ŒìŠ¤ë¥¼ Watch í•˜ê³  ìˆëŠ”ê°€?
3. ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì€ ê³ ë£¨í‹´ìœ¼ë¡œ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰

---

# Deployment ê°œìš”

- [OpenShift](https://github.com/kubernetes/kubernetes/issues/1743#issuecomment-91431450) ì—ì„œ ë§Œë“¤ì–´ì§„ ê°œë…ì´ K8s ì— ì ìš©ëœ ì‚¬ë¡€
- í˜„ì¬ K8s ì—ì„œ ê°€ì¥ ê¸°ë³¸ì ìœ¼ë¡œ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ë¦¬ì†ŒìŠ¤
- Deployment > ReplicaSet > Pod
- ReplicaSet ê³¼ ë³„ë„ë¡œ ì¡´ì¬í•˜ëŠ” ì´ìœ :
  - ReplicaSet ì€ ìˆ«ì ìœ ì§€ì— ì´ˆì ì„ ë‘ 
  - Deployment ëŠ” ìˆ«ì ì¡°ì ˆì— ì´ˆì ì„ ë‘ 

---

# Deployment ì½”ë“œ

[src](https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/deployment/deployment_controller.go#L64-L98) [types](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/apps/v1/types.go#L354-L369)

- ê²°êµ­ `processNextWorkItem` > `syncDeployment` ë¡œ ê·€ê²°
- ê¸°ë³¸ì ìœ¼ë¡œ ReplicaSet ë§Œ ì¡°ì‘
- ì‚­ì œë¡œì§ì€ ì—†ìŒ > Owner Reference ë¥¼ í†µí•œ GC ì— ì˜ì¡´
- `EqualIgnoreHash(&rsList[i].Spec.Template, &deployment.Spec.Template)`

---

# Deployment ì§ˆë¬¸

Q. ë…¸ë“œ 3ê°œì— Replicas ê°€ 99ë¡œ ì„¤ì •ëœ Deploymentë¥¼ ë°°í¬í•˜ë©´ Pod ì€ ì–´ë–»ê²Œ ë°°í¬ë ê¹Œ?
Q. ReadWriteOnce íŠ¹ì§•ì„ ê°€ì§„ PVë¥¼ Deploymentë¡œ ê´€ë¦¬í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
Q. Elasticsearch, etcd, ZooKeeper ë¥¼ Deployment ë¡œ ê´€ë¦¬í•˜ê¸° ê¹Œë‹¤ë¡œìš´ ì´ìœ ?

---

# StatefulSet ê°œìš”

- ë³¸ë˜ ì´ë¦„ì€ PetSet (Q. Petì˜ ë°˜ëŒ€ë˜ëŠ” ê°œë…ì€?)
- 3ê°œì˜ ë¬¸ì œ ì œê¸°ì—ì„œ ì‹œì‘ [Link](https://github.com/kubernetes/kubernetes/issues/260)
- 3ê°€ì§€ íŠ¹ì§•
  1. ê°œë³„ Pod ì„ íŠ¹ì •í•˜ê¸° ì‰½ê²Œ ë„¤ì´ë°
  2. ê°œë³„ Pod ê³¼ ì—°ê²°í•˜ê¸° ì‰½ê²Œ DNS ì£¼ì†Œ ë¶€ì—¬
  3. PVC ê´€ë¦¬ê°™ì´í•´ì¤Œ

---

# StatefulSet ì½”ë“œ

[src](https://github.com/kubernetes/kubernetes/blob/v1.27.4/pkg/controller/statefulset/stateful_set.go#L52-L77) [types](https://github.com/kubernetes/kubernetes/blob/v1.27.4/staging/src/k8s.io/api/apps/v1/types.go#L40-L62)

- ë˜‘ê°™ì´, ê²°êµ­ `processNextWorkItem` > `syncStatefulSet` ë¡œ ê·€ê²°
- StatefulSet ì€ Pod ì„ ì§ì ‘ ì¡°ì‘

---

# StatefulSet ì§ˆë¬¸

Q. Pod ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í•˜ê³  ì‹¶ìœ¼ë©´?
Q. íŠ¹ì • ë…¸ë“œì— íŠ¹ì • Pod ì„ ë„ìš°ê³  ì‹¶ìœ¼ë©´? (e.g., ë¬¼ë¦¬ì ìœ¼ë¡œ íŠ¹ì • ë…¸ë“œì—ì„œë§Œ PV ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤)
Q. ì´ë¯¸ ìƒì„±í•œ PVC ë³¼ë¥¨ í¬ê¸°ë¥¼ í‚¤ìš°ê³  ì‹¶ìœ¼ë©´? ([ã…...](https://github.com/kubernetes/kubernetes/issues/68737))

---

# DaemonSet ê°œìš”

- ë¡œê·¸ìˆ˜ì§‘í•˜ê±°ë‚˜ í•˜ë‚˜ì˜ ë…¸ë“œì— í•˜ë‚˜ì˜ ì„œë²„ë§Œ ë„ìš°ëŠ” (HDFS) ìš”êµ¬ì‚¬í•­ìœ¼ë¡œ ë‚˜ì˜¨ ì»¨ì…‰ [link](https://github.com/kubernetes/kubernetes/issues/1518)
- ì‹¤ì œ Productionì—ì„œ ì˜ì™¸ë¡œ StatefulSet ê³¼ ê³ ë¯¼í•˜ëŠ” ê²½ìš°ê°€ ì¢…ì¢… ìˆìŒ
- ë¡œê·¸ & ë©”íŠ¸ë¦­ / ë„¤íŠ¸ì›Œí‚¹ / ìŠ¤í† ë¦¬ì§€ ì—ì´ì „íŠ¸ ìš©ë„ë¡œ ìì£¼ ì‚¬ìš©

---

# DaemonSet ì½”ë“œ

[src](https://github.com/kubernetes/kubernetes/blob/v1.27.4/pkg/controller/daemon/daemon_controller.go) [types](https://github.com/kubernetes/kubernetes/blob/v1.27.4/staging/src/k8s.io/api/apps/v1/types.go#L40-L62)

- Pod ìƒì„± ì‹œë¶€í„° nodeName ì„ ì§€ì •í•´ì„œ ìƒì„±í•˜ëŠ” ê²ƒì´ íŠ¹ì§• (kube-scheduler ì˜í–¥ X) [link](https://github.com/kubernetes/kubernetes/blob/v1.27.4/pkg/controller/daemon/daemon_controller.go#L1351)
- StatefulSet ê³¼ ë¹„ìŠ·í•˜ê²Œ `RollingUpdate` ê³¼ `OnDelete` ë‘ê°€ì§€ê°€ ì¡´ì¬
- Taint ë„ ì´ê³³ì—ì„œ ì²˜ë¦¬ [link](https://github.com/kubernetes/kubernetes/blob/v1.27.4/pkg/controller/daemon/daemon_controller.go#L1318) (kubelet ìª½ì—ì„œëŠ” Taint / Tolerant ê²€ì¦ ì•ˆí•¨)

---

# DaemonSet ì§ˆë¬¸

Q. ì–´ë””ë‹¤ ì“°ë©´ ì¢‹ì„ê¹Œìš”?
Q. `ingress-nginx` ë‘ ê°™ì´ ì¨ë³´ëŠ”ê±° ì–´ë–»ê²Œ ìƒê°í•˜ì„¸ìš”?
Q. `kubectl rollout restart` ëŠ” ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?

---

# Q & A
